<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: modules/schema.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: modules/schema.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>import { randomAsHex, encodeAddress } from '@polkadot/util-crypto';
import { validate } from 'jsonschema';

import { getSignatureFromKeyringPair } from '../utils/misc';

export const SchemaQualifier = 'schema:dock:';
export const SchemaByteSize = 32;
export const EncodedIDByteSize = 48;

function createNewSchemaID() {
  const hexId = randomAsHex(SchemaByteSize);
  const ss58Id = encodeAddress(hexId);
  return `${SchemaQualifier}${ss58Id}`;
}

const jsonSchemaSpec = {
  description: 'Schema Object Validation',
  type: 'object',
  properties: {
    $schema: {
      type: 'string',
    },
    description: {
      type: 'string',
    },
    type: {
      type: 'string',
    },
    properties: {
      type: 'object',
    },
    additionalProperties: {
      type: 'any',
    },
  },
  required: ['$schema', 'type', 'properties'],
  additionalProperties: true,
};

export default class Schema {
  // Create a new `Schema` object
  // id is optional, if not given, generate a random id
  constructor(id) {
    this.id = id || createNewSchemaID();
    this.name = '';
    this.version = '1.0.0';
  }

  // Add the JSON schema to this object after checking that `json` is a valid JSON schema.
  // Check if JSON is valid.
  setJSONSchema(json) {
    if (!Schema.validateSchema(json)) {
      throw new Error('Invalid schema');
    }
    this.schema = json;
  }

  // Update the object with `author` key. Repeatedly calling it will keep resetting the author
  // did can be a DID hex identifier or full DID
  setAuthor(did) {
    // TODO: did validation
    this.author = did;
  }

  // Update the object with `signature` key. This method is used when
  // signing key/capability is not present and the signature is received from outside.
  // Repeatedly calling it will keep resetting the `signature` key.
  // The signature must be one of the supported objects
  setSignature(signature) {
    // TODO: ensure is signature
    this.signature = signature;
  }

  // Serializes the object using `getSerializedBlob` and then signs it using the given
  // polkadot-js pair. The object will be updated with key `signature`. Repeatedly calling it will
  // keep resetting the `signature` key
  sign(pair) {
    const msg = [1, 2, 3, 4];
    this.signature = getSignatureFromKeyringPair(pair, msg);
  }

  /**
   * Serializes to JSON for sending to the node, as `Blob`. A full DID is converted to the
   * hex identifier and signature object is converted to the enum
   * @returns {any}
   */
  toJSON() {
    const {
      signature,
      ...rest
    } = this;
    return rest;
  }

  // Check that the given JSON schema is compliant with JSON schema spec mentioned in RFC
  static validateSchema(json) {
    const result = validate(json, jsonSchemaSpec, {
      throwError: true
    });
    return true;
  }

  /**
    Get schema from from the chain using the given id, by querying the blob storage.
    Accepts a full blob id like blob:dock:0x... or just the hex identifier and the `DockAPI` object.
    The returned schema would be formatted as specified in the RFC (including author DID, schema id) or an error is
    returned if schema is not found on the chain or in JSON format.
  */
  static async getSchema(id, dockApi) {
    // requires blob module
    throw new Error(`invalid schema id ${id}`, dockApi);
  }
}
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="DIDModule.html">DIDModule</a></li><li><a href="DockAPI.html">DockAPI</a></li><li><a href="module.html#.exports">exports</a></li><li><a href="module.exports_module.exports.html">exports</a></li><li><a href="NoDIDError.html">NoDIDError</a></li><li><a href="RevocationModule.html">RevocationModule</a></li><li><a href="VerifiableCredential.html">VerifiableCredential</a></li><li><a href="global.html#VerifiablePresentation">VerifiablePresentation</a></li></ul><h3>Global</h3><ul><li><a href="global.html#addOwner">addOwner</a></li><li><a href="global.html#buildDockCredentialStatus">buildDockCredentialStatus</a></li><li><a href="global.html#checkRevocationStatus">checkRevocationStatus</a></li><li><a href="global.html#createDidRemoval">createDidRemoval</a></li><li><a href="global.html#createKeyDetail">createKeyDetail</a></li><li><a href="global.html#createKeyUpdate">createKeyUpdate</a></li><li><a href="global.html#createNewDockDID">createNewDockDID</a></li><li><a href="global.html#createPresentation">createPresentation</a></li><li><a href="global.html#createRandomRegistryId">createRandomRegistryId</a></li><li><a href="global.html#createSignedDidRemoval">createSignedDidRemoval</a></li><li><a href="global.html#createSignedKeyUpdate">createSignedKeyUpdate</a></li><li><a href="global.html#ensureObject">ensureObject</a></li><li><a href="global.html#ensureObjectWithId">ensureObjectWithId</a></li><li><a href="global.html#ensureObjectWithKey">ensureObjectWithKey</a></li><li><a href="global.html#ensureObjectWithKeyOrURI">ensureObjectWithKeyOrURI</a></li><li><a href="global.html#ensureString">ensureString</a></li><li><a href="global.html#ensureURI">ensureURI</a></li><li><a href="global.html#ensureValidDatetime">ensureValidDatetime</a></li><li><a href="global.html#from">from</a></li><li><a href="global.html#fromHex">fromHex</a></li><li><a href="global.html#fromKeyringPair">fromKeyringPair</a></li><li><a href="global.html#fromPolkadotJSKeyringPair">fromPolkadotJSKeyringPair</a></li><li><a href="global.html#generateEcdsaSecp256k1Keypair">generateEcdsaSecp256k1Keypair</a></li><li><a href="global.html#getBytesForStateChange">getBytesForStateChange</a></li><li><a href="global.html#getDockRevIdFromCredential">getDockRevIdFromCredential</a></li><li><a href="global.html#getHexIdentifierFromDID">getHexIdentifierFromDID</a></li><li><a href="global.html#getKeyPairType">getKeyPairType</a></li><li><a href="global.html#getPublicKeyFromKeyringPair">getPublicKeyFromKeyringPair</a></li><li><a href="global.html#getSchema">getSchema</a></li><li><a href="global.html#getSignatureFromKeyringPair">getSignatureFromKeyringPair</a></li><li><a href="global.html#getSignatures">getSignatures</a></li><li><a href="global.html#getSuiteFromKeyDoc">getSuiteFromKeyDoc</a></li><li><a href="global.html#getUniqueElementsFromArray">getUniqueElementsFromArray</a></li><li><a href="global.html#hasDockRevocation">hasDockRevocation</a></li><li><a href="global.html#isHexWithGivenByteSize">isHexWithGivenByteSize</a></li><li><a href="global.html#isObject">isObject</a></li><li><a href="global.html#isRevocationCheckNeeded">isRevocationCheckNeeded</a></li><li><a href="global.html#isString">isString</a></li><li><a href="global.html#issueCredential">issueCredential</a></li><li><a href="global.html#isVerifiedCredential">isVerifiedCredential</a></li><li><a href="global.html#isVerifiedPresentation">isVerifiedPresentation</a></li><li><a href="global.html#resolve">resolve</a></li><li><a href="global.html#set">set</a></li><li><a href="global.html#signDidRemoval">signDidRemoval</a></li><li><a href="global.html#signerFactory">signerFactory</a></li><li><a href="global.html#signKeyUpdate">signKeyUpdate</a></li><li><a href="global.html#signPresentation">signPresentation</a></li><li><a href="global.html#toJSON">toJSON</a></li><li><a href="global.html#toMap">toMap</a></li><li><a href="global.html#validateByteSize">validateByteSize</a></li><li><a href="global.html#validateCredentialSchema">validateCredentialSchema</a></li><li><a href="global.html#validateDockDIDHexIdentifier">validateDockDIDHexIdentifier</a></li><li><a href="global.html#validateDockDIDSS58Identifier">validateDockDIDSS58Identifier</a></li><li><a href="global.html#verifier">verifier</a></li><li><a href="global.html#verifierFactory">verifierFactory</a></li><li><a href="global.html#verifyCredential">verifyCredential</a></li><li><a href="global.html#verifyEcdsaSecp256k1Sig">verifyEcdsaSecp256k1Sig</a></li><li><a href="global.html#verifyPresentation">verifyPresentation</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 3.6.4</a> on Tue May 12 2020 17:34:45 GMT+0000 (Coordinated Universal Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
